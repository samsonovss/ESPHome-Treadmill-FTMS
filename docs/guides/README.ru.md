# Полная реализация бортового компьютера беговой дорожки на базе ESPHome

Превратите старую беговую дорожку в современного умного помощника для тренировок! Этот проект — полноценная замена бортового компьютера на базе ESP32-S3 и прошивки ESPHome. Он добавляет поддержку протокола [Fitness Machine Service (FTMS)](/docs/specs/FTMS_v1.0.pdf) для прямого общения тренажёра с фитнес-приложениями через Bluetooth, без необходимости в мостах и сторонних приложениях. Также включает интеллектуальные программы на основе пульса и встроенные тренировочные режимы. Разработан для дорожек с платами PSA(xx), но адаптируется к любой модели с UART. Минимум затрат — максимум возможностей!

### Поддерживаемые FTMS-приложения
- :white_check_mark: Zwift
- :white_check_mark: Kinomap (Android/iOS)
- :white_check_mark: FitShow
- :white_check_mark: Kinni
- :white_check_mark: qdomyos

**[English version](/README.md)**

## Оглавление
- [О проекте](#О-проекте)
- [Как это работает](#как-это-работает)
- [UART парсинг](UART_PARSING.ru.md)
- [Рекомендуемое оборудование](#рекомендуемое-оборудование)
- [Подключение](#подключение)
- [Функции](#функции)
- [Настройка ESPHome](#настройка-esphome)
- [Пример результатов тренировки](#пример-результатов-тренировки)
- [Планы развития](#Планы-развития)
- [История изменений](/CHANGELOG.md)

## О проекте
- **Цель**: Заменить устаревший бортовой компьютер беговой дорожки на современное решение.
- **Ключевые особенности**:
  - Полная реализация бортового компьютера на ESP32-S3 с прошивкой ESPHome.
  - Интеграция протокола [Fitness Machine Service (FTMS)](/docs/specs/FTMS_v1.0.pdf) для прямого подключения к фитнес-приложениям (Zwift, Kinomap и др.) через Bluetooth Low Energy (BLE) без посредников.
  - Минималистичный дизайн с компактным экраном (Nextion), отображающим скорость, время и дистанцию, не перекрываемым планшетом.
  - Поддержка UART для связи с платой дорожки, например, PSA(xx).
  - Интеллектуальные алгоритмы регулировки скорости и наклона на основе данных пульсометра.

## Как это работает
Проект использует ESP32-S3 для связи с платой беговой дорожки (например, PSA(xx)) через UART. Команды вроде `[SETSPD:010]` (1 км/ч) или `[SETINC:000]` (0%) были расшифрованы путём анализа трафика с помощью [UART-логгера](UART_PARSING.ru.md). Микроконтроллер обрабатывает эти данные, преобразует их в реальные значения скорости и наклона, а затем передаёт через Bluetooth Low Energy (BLE) в приложения, такие как Zwift, или сохраняет локально для анализа в Grafana.

Пульсометр подключается через BLE и передаёт данные о пульсе. Интеллектуальные алгоритмы в реальном времени анализируют пульс и плавно регулируют настройки дорожки, чтобы поддерживать заданную тренировочную зону. Например, если пульс выходит за пределы цели, скорость автоматически корректируется для индивидуальной и эффективной тренировки.

## Важный момент: Почему я убрал верхний бортовой компьютер
- **Проблемы с оригинальным бортовым компьютером**:
  1. **Конфликт команд**: При попытке отправлять команды с верхнего бортового компьютера напрямую к нижней плате они успешно передаются, но верхняя плата продолжает слать свои данные, перебивая мои команды.
     - Решение: Отправлять команды по UART на верхнюю плату, чтобы она задавала скорость и наклон, а затем передавала их нижней. Однако я не смог реализовать отправку данных на верхнюю плату. Вместо этого команды успешно и просто передаются напрямую на нижнюю плату.
  2. **Устаревший дизайн**: Оригинальный бортовой компьютер громоздкий, занимает много места. Удобно класть планшет, но он перекрывает дисплей с данными о скорости, наклоне и дистанции.
- **Моё решение**:
  - Полностью убрал верхний бортовой компьютер.
  - Разработать панель с минималистичным дизайном и компактным экраном (Nextion), где скорость, время и дистанция всегда видны, а сверху при желании добавить или планшет или монитор

## Считывание и парсинг данных UART
Для интеграции с беговой дорожкой необходимо подключиться к UART и декодировать данные (например, скорость `[SETSPD:010]`, наклон `[SETINC:000]`). Подробная инструкция по подключению, считыванию сырых данных и их декодированию находится в [UART_PARSING.md](UART_PARSING.ru.md).

## Преимущества
- **Гибкость**: Совместимость с любыми дорожками, поддерживающими UART.
- **Современность**: Полная замена бортового компьютера на базе ESP32-S3.
- **Прямая связь**: FTMS через BLE без мостов и сторонних приложений.
- **Доступность**: Минимальные затраты на оборудование.

## Рекомендуемое оборудование
  <details>
  <summary><b>ESP32-S3</b>: Настоятельно рекомендуется для высокой производительности и поддержки BLE. (▶️ Нажмите для деталей)</summary>
  <img src="/docs/images/esp32-s3.png" alt="ESP32-S Скриншот" width="400"/>
  </details>
  
  <details>
  <summary><b>LM2596S</b>: Преобразователь напряжения с 12В на 5В (неизолированный). (▶️ Нажмите для деталей)</summary>
  <img src="/docs/images/LM2596S.jpg" alt="LM2596S Скриншот" width="400"/>
  </details>
  
  <details>
  <summary><b>2-канальный преобразователь уровня</b>: Для согласования 5В (PSA(xx)) и 3.3В (ESP32 S3). (▶️ Нажмите для деталей)</summary>
  <img src="/docs/images/2-channel_level_shifter.webp" alt="LM2596S Скриншот" width="400"/>
  </details>
    
  <details>
  <summary><b>Дисплей Nextion</b>: Для улучшенного пользовательского интерфейса и взаимодействия. (▶️ Нажмите для деталей)</summary>
  <img src="/docs/images/nextion_display.jpg" alt="Скриншот дисплея" width="400"/>
  </details>
  
  <details>
  <summary><b>FC33</b>: Оптический датчик скорости для калибровки дорожки (опционально). (▶️ Нажмите для деталей)</summary>
  <img src="/docs/images/FC-33_speed_sensor.jpg" alt="Скриншот оптического датчика скорости" width="400"/>
  </details>
  
  <details>
  <summary><b>Беговая дорожка</b>: В идеале с платой PSA(xx), но подойдёт любая модель с поддержкой UART (RX-TX). (▶️ Нажмите для деталей)</summary>
  <img src="/docs/images/PSA(XX)H.jpg" alt="Скриншот платы PSA(xx)"/>
  </details>

## Подключение
<details>
<summary>▶️ Нажмите для деталей подключения</summary>

- ESP32-S3:
  - GPIO17 (TX): Передаёт данные на RX (пин 5) платы PSA(xx) через преобразователь уровня.
  - GPIO18 (RX): Принимает данные от TX (пин 4) платы PSA(xx) через преобразователь уровня.
  - GND: Общий заземлитель с преобразователем уровня (сторона 3.3В).
  - 3.3В: Источник питания для низковольтной (LV) стороны преобразователя уровня.
- ESP32-S3 (подключение питания):
  - LV (низкое напряжение): Сторона 3.3В подключена к ESP32.
  - HV (высокое напряжение): Сторона 5В подключена к PSA(xx).
  - GND (LV): Заземление от ESP32.
  - Vcc (LV): 3.3В от ESP32.
  - GND (HV): Заземление от LM2596S.
  - Vcc (HV): 5В от LM2596S.
- Плата PSA(xx) (6-пиновый разъём):
  - Пин 1 (12В): Подаёт питание на плату, питает вход LM2596S и подключается к пину 6 (SW).
  - Пин 2: Не подключён (не используется).
  - Пин 3 (GND): Общий заземлитель с LM2596S и преобразователем уровня.
  - Пин 4 (TX): Передаёт данные на GPIO18 (RX) ESP32 через преобразователь уровня.
  - Пин 5 (RX): Принимает данные от GPIO17 (TX) ESP32 через преобразователь уровня.
  - Пин 6 (SW): Подключён к пину 1 (12В) для включения дорожки.
- Плата PSA(xx) (дополнительная 6-пиновая секция):
  - Вход 12В: Получает питание от пина 1 (12В) платы PSA(xx).
  - Выход 5В: Подаёт питание на сторону Vcc (HV) преобразователя уровня.
  - GND: Общий заземлитель с PSA(xx) и преобразователем уровня.
- Дисплей Nextion:
  - TX: Передаёт данные на RX (GPIO43) ESP32-S3.
  - RX: Принимает данные от TX (GPIO44) ESP32-S3.
  - GND: Заземление от LM2596S.
  - Vcc: 5В от LM2596S.

</details>

## Функции
### Основные функции
- <details>
  <summary><b>Поддержка Zwift</b>: Полная интеграция с популярной платформой. (▶️ Нажмите для деталей)</summary>
  <img src="/docs/images/Zwift.gif" alt="Скриншот беговой дорожки с Zwift"/>
  </details>
- **Поддержка FTMS**: Совместимость с Kinomap, FitShow и Kinni.
- **Пульсометр**: Подключается через BLE с расчётом зон на основе возраста и пола.
- **Реальные данные**: Точные проценты наклона и калибровка скорости.
- **Управление кнопками**: Регулировка скорости и наклона через GPIO с обратной связью.
- **Ручной режим**: Тренировка без пульсометра.
- **Локальное хранение**: Сохранение тренировок и их визуализация в Grafana.
- **Интерфейс**:
  <details>
  <summary><b>Дисплей Nextion</b>: Поддерживает сенсорный дисплей для удобного мониторинга тренировок и управления дорожкой. (▶️ Нажмите для деталей)</summary>
  <img src="/docs/images/nextion_desine.png" alt="Скриншот дисплея Nextion"/>
  </details>
  <details>
  <summary><b>Интерфейс Hassio</b> (▶️ Нажмите для деталей)</summary>
  <img src="/docs/images/hassio.png" alt="Скриншот интерфейса Hassio"/>
  </details>

## Пример результатов тренировки
- После завершения тренировки результаты записываются в лог в формате "Workout Summary". Пример:
```yaml
  ===== Workout Summary =====
  User: Gender=Male, Age=41 years, Weight=75.0 kg, Max HR=181 bpm
  Duration: 33.87 min (2032 sec)
  Distance: 3.42 km
  Calories: 178 kcal
  Fat Burned: 9.6 g
  Avg Speed: 6.06 km/h
  Avg Incline: 1.85% (Real Incline: 0.62%)
  Avg MET: 4.21
  Avg VO2: 14.7 ml/kg/min
  Avg Heart Rate: 121 bpm
  Max Heart Rate: 138 bpm
  Heart Rate Zones: Zone1=1:57, Zone2=12:23, Zone3=17:12, Zone4=0:00, Zone5=0:00
  ===== End of Summary =====
```

### Интеллектуальная регулировка
- **Поддержание пульса**: скорость меняется плавно в зависимости от разницы с целевой зоной:
  - Разница > 10 уд/мин: ±0.5 км/ч с шагом 0.1 каждые 2 секунды.
  - Разница < 10 уд/мин: ±0.1 км/ч каждые 20 секунд.

### Разминка
- **Плавный старт**: Скорость увеличивается на 0.1 км/ч каждые 10 секунд в течение заданного периода разминки. Если пульс не достигает Зоны 1 за установленное время, в статусе отображается сообщение, например: «Ожидание пульса 91».
- **Динамическое ускорение**: Если пульс остаётся ниже Зоны 1, через 10 секунд скорость увеличивается на 0.5 км/ч с плавным нарастанием, ждет 10 секунд при необходимости повторяет увеличение на 0.5 км/ч.
- **Переход к основной программе**: Разминка завершается, как только пульс достигает Зоны 1, с плавным переходом к основной программе тренировки.

### Заминка
- **Плавное снижение**: уменьшает скорость, пока пульс не вернётся в зону 1.
- **Настраиваемое время**: работает по аналогии с разминкой.

### Тренировочные программы на основе пульса
- **Пользовательская зона**: Поддерживает заданную зону пульса через регулировку скорости.
- **Сжигание жира**: Зона 2 с плавным управлением скоростью и наклоном.
- **Интервалы**: Чередование Зон 1 и 4 на основе пульса с автоматической настройкой скорости.
- **Восстановление**: Поддержание Зоны 1 для лёгкого бега.
  
## Настройка ESPHome
Файл (config.yaml) настраивает ESP32 S3 для управления беговой дорожкой и подключения пульсометра.
- Конфигурация UART для связи с беговой дорожкой (используется для отправки и получения команд)
```yaml
uart:
  tx_pin: GPIO17    # Передача данных (TX) на GPIO17
  rx_pin: GPIO18    # Приём данных (RX) на GPIO18

# Настройка Bluetooth Low Energy (BLE) для подключения пульсометра
ble_client:
  - mac_address: "XX:XX:XX:XX:XX:XX"  # Замените на MAC-адрес вашего пульсометра
```
## Планы развития
- :white_check_mark:Расширение поддержки FTMS для совместимости Kinomap на iOS
- Добавить Программу фитнес тестирования
- Добавление интерактивных карт высот и новых тренировочных программ.
- :white_check_mark:Разработка дисплея с удобным интерфейсом.
- Поддержка автоматического наклона в Zwift.
- Создание универсальной платы для упрощённой сборки.
- Разработка компонента ESPHome для бесшовной интеграции в экосистему.
- Интеграция датчика расстояния (TOF400C-VL53L1X) для управления скоростью без кнопок.
- Передача данных через MQTT для интеграции вне Home Assistant.
- Создание веб-интерфейса для управления без Home Assistant.

## История изменений
Для подробной истории изменений см. [CHANGELOG.md](/CHANGELOG.md).

## Авторы
Создано [@samsonovss](https://t.me/samsonovss) & xAI Assistant

### **Поддержите проект**  
Если вы хотите поддержать проект и помочь его развитию, угостите меня кофе! Ваши пожертвования помогают улучшать проект:
- **PayPal**: samsonov@hotmail.com
- **BTC:** `bc1q3cza0kasutzes4hfddxuclmd9ghn5v7zw2nr5c`  
- **USDT (TRC-20):** `0x5dd5a346Dd64dfE938a60D7b24b633b1ACE01719`
  
Любая поддержка важна — спасибо!
