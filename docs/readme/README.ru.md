# Превратите старую беговую дорожку в умную с FTMS на ESPHome и ESP32-S3 BLE с дисплеем Nextion

### Поддерживаемые приложения FTMS
- :white_check_mark: Zwift
- :white_check_mark: Kinomap (Android/iOS)
- :white_check_mark: FitShow
- :white_check_mark: Kinni
- :white_check_mark: qdomyos

**[English version](README.md)**

## О проекте
Превратите старую беговую дорожку в умного помощника для тренировок! С помощью ESP32-S3 и прошивки ESPHome вы добавите поддержку FTMS для фитнес-приложений через BLE, а также интеллектуальные программы на основе пульса и встроенные тренировочные режимы. Проект разработан для дорожек с платами PSA(xx), но подходит для любой модели с UART. Минимум затрат — максимум возможностей!

## Как это работает
Проект использует ESP32-S3 для связи с платой беговой дорожки (например, PSA(xx)) через UART. Команды вроде `[SETSPD:010]` (1 км/ч) или `[SETINC:000]` (0%) были расшифрованы путём анализа трафика с помощью UART-логгера. Микроконтроллер обрабатывает эти данные, преобразует их в реальные значения скорости и наклона, а затем передаёт через Bluetooth Low Energy (BLE) в приложения, такие как Zwift, или сохраняет локально для анализа в Grafana.

Пульсометр подключается через BLE и передаёт данные о пульсе. Интеллектуальные алгоритмы в реальном времени анализируют пульс и плавно регулируют настройки дорожки, чтобы поддерживать заданную тренировочную зону. Например, если пульс выходит за пределы цели, скорость автоматически корректируется для индивидуальной и эффективной тренировки.

### Преимущества
- **Гибкость**: работает с любыми дорожками, поддерживающими UART.
- **Современность**: Работает на мощном микроконтроллере ESP32-S3.
- **Доступность**: Требует минимум компонентов.

## Рекомендуемое оборудование
- **ESP32-S3** (настоятельно рекомендуется из-за производительности и поддержки BLE).
- **LM2596S**: преобразователь напряжения с 12 В на 5 В (неизолированный).
- **2-канальный преобразователь уровней**: для согласования 5 В (PSA(xx)) и 3.3 В (ESP32 S3).
- **Беговая дорожка**: идеально — с платой **[PSA(xx)](/docs/readme/images/PSA(XX)H.jpg)**, но подойдёт любая с UART (RX-TX).
- **Дисплей Nextion**: для улучшенного пользовательского интерфейса и взаимодействия.
 ![Treadmill Screenshot](docs/readme/images/PSA(XX)H.jpg)

## Подключение
- **ESP32-S3**:
  - GPIO17 (TX) → передача данных на RX (Pin 5) PSA(xx) через преобразователь уровней
  - GPIO18 (RX) → приём данных от TX (Pin 4) PSA(xx) через преобразователь
  - GND → общая земля с преобразователем (сторона 3.3 В)
  - 3.3V → питание для стороны Low Voltage (LV) преобразователя
- **ESP32-S3** (логический преобразователь уровней)
  - LV (Low Voltage) — сторона 3.3 В, подключена к ESP32
  - HV (High Voltage) — сторона 5 В, подключена к PSA(xx)
  - GND (LV) — земля от ESP32
  - Vcc (LV) — 3.3 В от ESP32
  - GND (HV) — земля от LM2596S
  - Vcc (HV) — 5 В от LM2596S
- **PSA(xx) Board (6 контактов):**
  - Pin 1 (12V) → питание платы, идёт на вход LM2596S и соединяется с Pin 6 (SW).
  - Pin 2 → пустой (не используется).
  - Pin 3 (GND) → общая земля с LM2596S и преобразователем.
  - Pin 4 (TX) → передача данных на GPIO18 (RX) ESP32 через преобразователь.
  - Pin 5 (RX) → приём данных от GPIO17 (TX) ESP32 через преобразователь.
  - Pin 6 (SW) → соединён с Pin 1 (12V) для включения беговой дорожки.
- **PSA(xx) Board (6 контактов):**
  - Input 12V → получает питание от Pin 1 (12V) PSA(xx).
  - Output 5V → питает сторону Vcc (HV) преобразователя.
  - GND → общая земля с PSA(xx) и преобразователем.
- **Дисплей Nextion:**
  - TX: Передает данные на RX (GPIO43) на ESP32-S3.
  - RX: Принимает данные от TX (GPIO44) на ESP32-S3.
  - GND: Земля от LM2596S.
  - Vcc: 5V от LM2596S.
    
## Возможности
### Основные функции
- **Поддержка Zwift**: Полная интеграция с популярной платформой.
  ![ESPHome Treadmill Zwift](docs/readme/images/Zwift.gif)
- **Поддержка FTMS**: Совместимость с Kinomap, FitShow и Kinni.
- **Пульсометр**: Подключение через BLE с расчётом зон на основе возраста и пола.
- **Реальные данные**: Точный наклон в процентах и калибровка скорости.
- **Управление кнопками**: Регулировка скорости и наклона через GPIO с обратной связью.
- **Ручной режим**: Тренировки без пульсометра.
- **Локальное хранение**: Сохранение пробежек и их визуализация в Grafana.
- **Nextion Display**: Поддержка сенсорного дисплея для удобного мониторинга тренировки и управления беговой дорожкой.
  ![ESPHome Treadmill Nextion](docs/readme/images/nextion.gif)

### Интеллектуальная регулировка
- **Поддержание пульса**: скорость меняется плавно в зависимости от разницы с целевой зоной:
  - Разница > 20 уд/мин: ±0.5 км/ч с шагом 0.1 каждые 2 секунды.
  - Разница < 20 уд/мин: ±0.1 км/ч каждые 20 секунд.

### Разминка
- **Умная разминка**: Плавно доводит пульс до Зоны 1 для подготовки связок.
- **Настраиваемое время**: Ждёт достижения Зоны 1, затем завершает по таймеру (например, 5 минут).

### Заминка
- **Плавное снижение**: уменьшает скорость, пока пульс не вернётся в зону 1.
- **Настраиваемое время**: работает по аналогии с разминкой.

### Тренировочные программы на основе пульса
- **Пользовательская зона**: Поддерживает заданную зону пульса через регулировку скорости.
- **Сжигание жира**: Зона 2 с плавным управлением скоростью и наклоном.
- **Интервалы**: Чередование Зон 1 и 4 на основе пульса с автоматической настройкой скорости.
- **Восстановление**: Поддержание Зоны 1 для лёгкого бега.
  
### Интерфейс в Hassio
![Hassio Interface](docs/readme/images/hassio.png)
  
## Настройка ESPHome
Файл (config.yaml) настраивает ESP32 S3 для управления беговой дорожкой и подключения пульсометра.
- Настройка UART для связи с беговой дорожкой (Используется для получения и отправки команд)
```yaml
uart:
  tx_pin: GPIO17    # Передача данных (TX) на GPIO17
  rx_pin: GPIO18    # Приём данных (RX) на GPIO18

# Настройка Bluetooth Low Energy (BLE) для подключения пульсометра
ble_client:
  - mac_address: "XX:XX:XX:XX:XX:XX"  # Замените на MAC-адрес вашего пульсометра
```
## Планы развития
- :white_check_mark:Расширение поддержки FTMS для совместимости Kinomap на iOS
- Добавить Программу фитнес тестирования
- Добавление интерактивных карт высот и новых тренировочных программ.
- :white_check_mark:Разработка дисплея с удобным интерфейсом.
- Поддержка автоматического наклона в Zwift.
- Создание универсальной платы для упрощённой сборки.
- Разработка компонента ESPHome для бесшовной интеграции в экосистему.
- Интеграция датчика расстояния (TOF400C-VL53L1X) для управления скоростью без кнопок.
- Передача данных через MQTT для интеграции вне Home Assistant.
- Создание веб-интерфейса для управления без Home Assistant.

## История изменений
- 17 мая 2025:
  - Добавлена интеграция дисплея Nextion в конфигурацию YAML.
  - Добавлен проект дизайна дисплея Nextion, созданный в программе Lunacy.
  - Добавлена прошивка дисплея Nextion (файл HMI) для Nextion Editor.
  - Добавлен скомпилированный файл `treadmill.tft` для прошивки дисплея.
- 12 апреля 2025 года:
  - Добавлена поддержка FTMS для Kinomap на iOS с использованием сокращённых UUID.
  - Добавлена поддержка статусов FTMS (Training Status / Fitness Machine Status)
- 9 апреля 2025: Начальная поддержка FTMS для Kinomap (Android), FitShow и Kinni.

## Авторы
Создано [@samsonovss](https://t.me/samsonovss) & xAI Assistant

### **Поддержите проект**  
Если вы хотите поддержать проект и помочь его развитию, угостите меня кофе! Ваши пожертвования помогают улучшать проект:
- **PayPal**: samsonov@hotmail.com
- **BTC:** `bc1q3cza0kasutzes4hfddxuclmd9ghn5v7zw2nr5c`  
- **USDT (TRC-20):** `0x5dd5a346Dd64dfE938a60D7b24b633b1ACE01719`
  
Любая поддержка важна — спасибо!
